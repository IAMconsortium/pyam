# This workflow runs the tests with the oldest explicitly supported versions of dependencies
# For more information see: https://help.github.com/actions/language-and-framework-guides/using-python-with-github-actions

name: pytest-legacy

on:
  push:
    branches: [ 'main' ]
  pull_request:
    branches: [ '**' ]

jobs:
  pytest-legacy:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      id: setup-python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    #----------------------------------------------
    #  -----  install & configure poetry  -----
    #----------------------------------------------
    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        virtualenvs-create: true
        virtualenvs-in-project: true
        installer-parallel: true
    #----------------------------------------------
    #       load cached venv if cache exists
    #----------------------------------------------
    - name: Load cached venv
      id: cached-poetry-dependencies
      uses: actions/cache@v4
      with:
        path: .venv
        key: venv-${{ runner.os }}-${{ steps.setup-python.outputs.python-version }}-${{ hashFiles('**/poetry.lock') }}

    - name: Enforce usage of specific out-dated version of dependencies
      # Update the package requirements when changing minimum dependency versions
      # Please also add a section "Dependency changes" to the release notes
      run: |
        poetry add iam-units@2020.4.21
        poetry add matplotlib@3.6.0
        poetry add numpy@1.26.0
        poetry add pandas@2.1.2
        poetry add pint@0.13
        poetry add xlrd@2.0.1 --group optional_io_formats

    #----------------------------------------------
    # install your root project, if required
    #----------------------------------------------
    - name: Install library
      run: poetry install --no-interaction --with optional_io_formats,optional_plotting,tests,tutorials


    - name: Test with pytest
      run: poetry run pytest tests
